<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Dashboard | Patrimonio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="min-h-screen bg-gray-50">
  <div class="max-w-7xl mx-auto p-6 space-y-6">
    <header class="flex items-center justify-between">
      <h1 class="text-2xl font-semibold">Dashboard</h1>
      <a href="{{ url_for('logout') }}" class="text-red-600 hover:underline">Cerrar sesión</a>
    </header>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="bg-white rounded-xl p-4 shadow">
        <p class="text-sm text-gray-500">Mobiliario</p>
        <p id="kpi-mobiliario" class="text-2xl font-bold">-</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <p class="text-sm text-gray-500">Anexos</p>
        <p id="kpi-anexos" class="text-2xl font-bold">-</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <p class="text-sm text-gray-500">Subdependencias</p>
        <p id="kpi-subdeps" class="text-2xl font-bold">-</p>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <p class="text-sm text-gray-500">Altas (registros)</p>
        <p id="kpi-altas" class="text-2xl font-bold">-</p>
      </div>
    </section>

    <!-- Gráficos -->
    <section class="grid grid-cols-1 lg:grid-cols-2 gap-6">
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-medium mb-3">Estado de conservación</h3>
        <canvas id="chartEstado"></canvas>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-medium mb-3">Mobiliario por rubro (Top 12)</h3>
        <canvas id="chartRubro"></canvas>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-medium mb-3">Mobiliario por anexo (Top 12)</h3>
        <canvas id="chartAnexo"></canvas>
      </div>
      <div class="bg-white rounded-xl p-4 shadow">
        <h3 class="font-medium mb-3">Evolución mensual</h3>
        <div class="grid grid-cols-1 gap-4">
          <div>
            <p class="text-sm text-gray-500 mb-1">Mobiliario (cantidad)</p>
            <canvas id="chartSerieMob"></canvas>
          </div>
          <div>
            <p class="text-sm text-gray-500 mb-1">Altas (total $)</p>
            <canvas id="chartSerieAltas"></canvas>
          </div>
        </div>
      </div>
    </section>
  </div>

  <script>
    async function loadDashboard() {
      const res = await fetch('/api/dashboard');
      if (!res.ok) {
        console.error('Error al cargar dashboard');
        return;
      }
      const data = await res.json();

      // KPIs
      document.getElementById('kpi-mobiliario').textContent = data.kpis.mobiliario.toLocaleString('es-AR');
      document.getElementById('kpi-anexos').textContent = data.kpis.anexos.toLocaleString('es-AR');
      document.getElementById('kpi-subdeps').textContent = data.kpis.subdependencias.toLocaleString('es-AR');
      document.getElementById('kpi-altas').textContent = data.kpis.altas.toLocaleString('es-AR');

      // Helpers
      const labels = (arr) => arr.map(x => x.label);
      const values = (arr) => arr.map(x => x.value);
      const months = (arr) => arr.map(x => x.mes);

      // Gráfico Estado (doughnut)
      new Chart(document.getElementById('chartEstado'), {
        type: 'doughnut',
        data: {
          labels: labels(data.por_estado),
          datasets: [{ data: values(data.por_estado) }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });

      // Por Rubro (bar)
      new Chart(document.getElementById('chartRubro'), {
        type: 'bar',
        data: {
          labels: labels(data.por_rubro),
          datasets: [{ label: 'Cantidad', data: values(data.por_rubro) }]
        },
        options: {
          responsive: true,
          scales: { x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } } }
        }
      });

      // Por Anexo (bar)
      new Chart(document.getElementById('chartAnexo'), {
        type: 'bar',
        data: {
          labels: labels(data.por_anexo),
          datasets: [{ label: 'Cantidad', data: values(data.por_anexo) }]
        },
        options: {
          responsive: true,
          scales: { x: { ticks: { autoSkip: false, maxRotation: 45, minRotation: 0 } } }
        }
      });

      // Serie Mobiliario (line)
      new Chart(document.getElementById('chartSerieMob'), {
        type: 'line',
        data: {
          labels: months(data.serie_mobiliario),
          datasets: [{ label: 'Mobiliario', data: values(data.serie_mobiliario) }]
        },
        options: { responsive: true }
      });

      // Serie Altas (line)
      new Chart(document.getElementById('chartSerieAltas'), {
        type: 'line',
        data: {
          labels: months(data.serie_altas),
          datasets: [{ label: 'Altas ($)', data: values(data.serie_altas) }]
        },
        options: {
          responsive: true,
          plugins: {
            tooltip: { callbacks: {
              label: (ctx) => ` $ ${Number(ctx.parsed.y || 0).toLocaleString('es-AR')}`
            }}
          },
          scales: {
            y: { ticks: { callback: v => '$ ' + Number(v).toLocaleString('es-AR') } }
          }
        }
      });
    }

    loadDashboard();
  </script>
</body>
</html>
